$.User=function(){this.bizType=0;this.catalog=0;this.bizName="";this.currency=0;this.shortId=0;this.calendar=null;this.checkFormFunc=undefined;this.call=null;this.dlgRequire=null;var a=this;this.appoint=function(){if(checkLogicals(["#edtContactName","#edtContactMobile","#edtContactWeixin"])==false){showInfo("联系方式都不能为空！");
return;}var b={};b.channel=0;b.catalog=0;b.description=$("#edtRequirement").val();b.people={};b.people.person=parseInt($("#lblReqCount").text());b.day=parseInt($("#lblReqDay").text());b.deptDate=$("#lblReqDate").text();b.contactPerson=$("#edtContactName").val();b.contactMobile=$("#edtContactMobile").val();
b.contactMSN=$("#edtContactWeixin").val();b.tags="[]";b.bizObject={};b.bizObject.catalog=parseInt($("#catalog").val());b.bizObject.type=bizPageNameBy(parseInt($("#bizType").val()),b.bizObject.catalog);b.bizObject.id=$("#shortId").val();b.bizObject.priceName=a.priceNameValue();b.bizObject.price=a.priceNameAmount();
b.funcIndex=1;b.moduleName="html5";showLoading(".lbFootera a");$.ajax({type:"POST",url:"/module",dataType:"json",async:false,data:JSON.stringify(b),success:function(c){hideLoading(".lbFootera a");if(c.xeach==false){showFail(c.message);return;}a.dlgRequire.close();showOk("提交成功，建议您下载我们的APP，及时与导游或客服沟通！");
}});};this.initActivity=function(e,c,d,f,b){this.bizType=e;this.catalog=c;this.bizName=d;this.shortId=f;this.currenty=b;this.calendar=$("#calendar").calendar({"bizType":this.bizType,"bizName":this.bizName,"catalog":this.catalog,"shortId":this.shortId,"currency":this.currenty,"css":"small",editable:false,change:function(g,h){a.handleCalendarChange(g,h);
}}).data("calendar");};this.showCarLabel=function(c){var b=$("div[class='details'] li[tag='car']");if(c){b.show();}else{b.hide();}};this.priceNameValue=function(){var b=$("#edtPriceName li.select");if(b.length>0){return b.attr("priceValue");}return"";};this.priceNameAmount=function(){var b=$("#edtPriceName li.select");
if(b.length>0){return b.attr("priceAmount");}return"";};this.readCalendarBy=function(){var b=a.priceNameValue();a.calendar.setOption("bizName",b);this.showCarLabel(b!="不带车");$("#priceNameHeader").text(b);a.calendar.readCalendar();};this.handleCalendarChange=function(b,c){if(b="reload"){$("#edtDeptDate").dateinput({"calendar":c,"onSelect":function(d){a.bookingChange("#calcLoading");
}});if(c.xeach==false){return;}$("#total-price").text(c.price);$("#price").text(c.price);a.bookingChange("#calcLoading");renderRules(c);}};this.initGallery=function(b){$(b).adGallery({callbacks:{afterImageVisible:function(){if($("#snapshot_").length>0){$("#snapshot_").text(this.images[this.current_index].thumb);
}}}});};this.postComment=function(b){if(checkLogin()==false){return false;}if($("#edtComment").val().length==0){showFail("请输入评价内容.");return;}var c={};c.funcIndex=1;c.bizType=parseInt($("#bizType").val());c.bizTitle=$("#bizTitle").val();c.bizUserId=parseFloat($("#userId").val());c.bizUserName=$("#userName").val();
c.shortId=parseFloat($("#shortId").val());c.catalog=parseInt($("#catalog").val());c.content=$("#edtComment").val();c.attributeScore=parseInt($("#edtAttributeScore").val());c.scheduleScore=parseInt($("#edtScheduleScore").val());c.expertScore=parseInt($("#edtExpertScore").val());c.score=parseInt($("#edtCommentScore").val());
showLoading(b);$.ajax({type:"POST",url:"/comment",dataType:"json",data:JSON.stringify(c),success:function(d){hideLoading(b);a.readComments(1,10);return false;}});};this.initComments=function(){this.readComments(1,10);};this.readComments=function(c,b){if($("#shortId").length==0){return;}var d=$("#shortId").val();
if(d.length==0){return;}var e={};e.funcIndex=0;e.pageNumber=c;e.pageSize=b;e.shortId=parseFloat(d);e.bizType=parseInt($("#bizType").val());$.ajax({type:"POST",url:"/comment",dataType:"json",async:false,data:JSON.stringify(e),success:function(f){if(f.xeach==false){return false;}a.renderComments(f,c,b);
}});};this.renderComments=function(f,c,b){var e=new JsEvalContext(f);var d=document.getElementById("comments");var g=jstGetTemplate("templateComment");d.innerHTML="";d.appendChild(g);jstProcess(e,d);renderPage("#pager",f.totalCount,c,b,this.readComments);};this.initTabs=function(){$("#tabs a").click(function(){$("#tabs a").removeClass("selected");
$("#tabs li").removeClass("current").removeClass("png");var c=$(this);c.addClass("selected");$("div[tag='tab']").hide();$(c.attr("tag")).show();var b=c.parent();b.addClass("current").addClass("png");});};this.initLogicals=function(b){addLogical("#edtContent","请输入内容");addLogical("#edtDeptDate","请选择预约日期");
addLogical("#edtTime","请输入预约"+$("#timeName").val());addLogical("#edtPersonCount","请输入人数");if(b=="product"){addLogical("#edtCount","请输入订购数量");}};this.initCall=function(){this.call=new $.Call(this);this.call.init();};this.fillReqForm=function(b){b.deptDate=$("#edtDeptDate").val().toTime();b.day=parseInt($("#edtTime").val());
b.personCount=parseInt($("#edtPersonCount").val());b.catalog=parseInt($("#catalog").val());b.shortId=parseFloat($("#shortId").val());b.bizType=parseInt($("#bizType").val());b.bizUrl=window.location.href;b.bizTitle=$("#bizTitle").val();b.bizName=$("#bizName").val();b.bizUserId=parseFloat($("#userId").val());
b.actionType="inquiry";};this.setCheckForm=function(b){this.checkFormFunc=b;};this.checkForm=function(){if(!this.checkFormFunc){return true;}return this.checkFormFunc();};this.bookingChange=function(k){if(documentLoading==true){return;}if(this.bizType==3){if(checkLogicals(["#edtCount"])==false){return;
}var i=$("#price").text().toInt();var j=$("#edtCount").val().toInt();var p=$("#post").text().toInt();$("#total-price").text(i*j+p);return;}if(checkLogicals(["#edtDeptDate"])==false){return;}var o=$("#edtDeptDate").val().toTime();var e=parseInt($("#edtTime").val());var f=parseInt($("#chargeWay").val());
var c=parseInt($("#edtPersonCount").val());var h=parseInt($("#catalog").val());var d=parseFloat($("#shortId").val());var l=parseInt($("#bizType").val());$("#bizName").val(a.priceNameValue());var b=$("#bizName").val();var g=0;var n=readCalcPriceObject(l,d,b,h,f,o,e,c,g);var m=calcPrice(k,n);$("#total-price").text(m);
};this.callNow=function(){return this.call.callNow(false);};this.initLocal=function(){var d=$("#localTime");var b=d.attr("data-date");var c=d.attr("data-time");localDateTime=new Date(b+" "+c);d.flipcountdown({size:"xs",tick:function(){localDateTime=new Date(localDateTime.getTime()+1000);return localDateTime;
}});};this.initRequireDialog=function(){a.dlgRequire=$("#dlgrequire").dialog({background:"white",centerOnResize:true,fade:true,width:550,height:350,zIndex:999,title:"提交需求",buttons:["立即提交"],onInit:function(){$("#edtRequirement").watermark();},onClick:function(b){if(b=="立即提交"){a.appoint();}},onShow:function(){$("#lblReqDate").text($("#edtDeptDate").val());
$("#lblReqDay").text($("#edtTime").val());$("#lblReqCount").text($("#edtPersonCount").val());$("#edtContactName").val($("#contactName").val());$("#edtContactWeixin").val($("#contactWeixin").val());$("#edtContactMobile").val($("#contactMobile").val());}}).data("dialog");};this.popRequire=function(){if(checkLogin()==false){return;
}a.dlgRequire.popup();};this.initScrollPage=function(){var d=$(".detail-item-title").offset().top-55;var f=$("#serviceProvided").offset().top-55;var b=$("#travelSharing").offset().top-55;var e=$("#evaluateDetails").offset().top-55;var j=$("#cityGuide").offset().top-55;var i=$("#xrightBoxWarp").offset().top-55;
var c=$("#item-foot").offset().top-55;var h=false;var g=[d,f,b,e,j,c];$(".head-title li").click(function(){var k=$(this).index();window.scrollTo(0,g[k]+1);});$(window).bind("scroll",function(){var m=$(document).scrollTop();var k=$("#xrightBox").height();var l=$("#item-foot").offset().top-55;if($(document).scrollTop()>0){$("#scoll-top").show();
}else{$("#scoll-top").hide();}if(m>=d){$(".detail-item-title-left").addClass("onfixed-l");}else{$(".detail-item-title-left").removeClass("onfixed-l");}if(m>=0&&m<f){$(".head-title").find("li:eq(0)").find("a").addClass("cur");$(".head-title").find("li:eq(0)").siblings().find("a").removeClass("cur");}else{if(m>=f&&m<b){$(".head-title").find("li:eq(1)").find("a").addClass("cur");
$(".head-title").find("li:eq(1)").siblings().find("a").removeClass("cur");}else{if(m>=b&&m<e){$(".head-title").find("li:eq(2)").find("a").addClass("cur");$(".head-title").find("li:eq(2)").siblings().find("a").removeClass("cur");}else{if(m>=e&&m<j){$(".head-title").find("li:eq(3)").find("a").addClass("cur");
$(".head-title").find("li:eq(3)").siblings().find("a").removeClass("cur");}else{if(m>=j){$(".head-title").find("li:eq(4)").find("a").addClass("cur");$(".head-title").find("li:eq(4)").siblings().find("a").removeClass("cur");}else{$(".head-title").find("li:eq(5)").find("a").addClass("cur");$(".head-title").find("li:eq(5)").siblings().find("a").removeClass("cur");
}}}}}if(m>=i&&m+k<l){$("#xrightBox").css({"position":"fixed","top":"55px","z-index":12});$("#xrightBox").find(".appinfo-title").removeClass("opacit");if(!h){if(m>b){$("#requireBox").hide();$("#shareMore").show();}else{$("#requireBox").show();$("#shareMore").hide();}}}else{if(m<i){h=false;$("#xrightBox").css({"position":"static","top":"55px"});
$("#xrightBox").find(".appinfo-title").addClass("opacit");$("#requireBox").show();$("#shareMore").hide();}else{$("#xrightBox").css({"top":55-m-k+l,"z-index":10});}}});$("#shareMore").bind("click",function(){h=true;$("#requireBox").show();$("#shareMore").hide();});};};$.Call=function(d){var f=null;var a=false;
var g;var e;var c=null;var i=this;var h=true;var b=null;this.user=d;this.init=function(){g=$("#dlgcall").dialog({background:"white",centerOnResize:true,fade:true,width:750,height:430,zIndex:999,title:"实时通讯",buttons:["关闭"],onInit:function(){$.ionSound({sounds:["msg"]});$("#edtMsg").watermark({onEnter:function(){if($("#dlgcall").is(":visible")){i.sendMsg();
}}});},onClick:function(j){if(j=="确定"){}},onShow:function(){i.updateScrollbar();}}).data("dialog");if(requests.get("action")=="call"){i.callNow();}};this.updateScrollbar=function(){if(e!=null){e.tinyscrollbar_update("bottom");return;}var j=$('#dlgcall div[class="scroller"]');if(j.length==0){return;}e=$('#dlgcall div[class="scroller"]').tinyscrollbar({size:100});
};this.showOffline=function(j){if(j){return;}i.enableOffline=false;i.addMessage("bubble-right","white",0,"一起嗨","非常抱歉，当前没有客服在线！您的消息将自动发送到客服留言信箱。<br>建议您<a target='_blank' class='redlink' href='/postreq/c=0'>点击此处发布您的详细需求</a>，所有留言我们将在12小时内回复！");};this.initWebSocket=function(j){$.msg({autoUnblock:false,msgID:1});
if(f!=null&&a){$.msg("unblock",0,1);g.popup();return;}f=new WebSocket(currentWebSocketUri);f.onopen=function(){a=true;var k={};k.action="enter";k.code=j?"reconnect":"connect";k.cookieId=$("#header").attr("cookieId");k.type=parseInt($("#bizType").val());k.catalog=parseInt($("#catalog").val());k.id=$("#shortId").val();
k.topicId="";k.topicParam=$("#bizName").val();k.tag=$("#userId").val();k.readMessages=true;f.send(JSON.stringify(k));};f.onmessage=function(l){var k=JSON.parse(l.data);if((k.action=="enter")){$.msg("unblock",0,1);if(k.xeach==true){i.msgId=k.msgId;g.popup();if(j==true){i.sendMessage(i.lastMessage);}i.showOffline(k.serviceOnline);
}}else{if(k.action=="say"){$.ionSound.play("msg");if($("#dlgcall").is(":visible")==false){g.popup();}if(k.from){i.addMessage("bubble-right","yellow",k.from.userId,k.from.userName,k.content);}else{i.addMessage("bubble-right","yellow",k.userId,k.userName,k.content);}}else{if(k.action=="notify"){i.addMessage("bubble-right","white",k.userId,k.userName,k.content);
}else{if(k.action=="readMessages"){i.renderMsgDetail(k);}}}}};f.onclose=function(k){a=false;i.enableOffline=true;if(i.lastMessage&&i.lastMessage.length!=0){i.callNow(true);}};f.onerror=function(k){i.addMessage("bubble-right","white",0,"客服中心","消息发送失败["+k.data+"]，请重试一次.");};};this.renderMsgDetail=function(l){var j=l.items;
if(j==undefined){return;}for(var k=0;k<j.length;k++){var m=j[k];if(currentUserId==m.userId){i.addMessage("bubble-left","orange",0,"我",m.content);}else{i.addMessage("bubble-right","yellow",m.userId,m.userName,m.content);}}};this.sendRequire=function(){var m={};m.action="say";var l=[];var k=$("#bizType").val().toInt();
switch(k){case 3:l.push("购买数量:"+$("#edtCount").val());l.push("尺寸规格:"+$("#edtModel").val());l.push("订购颜色:"+$("#edtColor").val());break;default:l.push("出发日期:"+$("#edtDeptDate").val());l.push("旅客人数:"+$("#edtPersonCount").val());l.push("预约天数:"+$("#edtTime").val());break;}var j=window.location.href;l.push("预订链接:"+j);
m.content=l.join("\r\n");m.cookieId=$("#header").attr("cookieId");m.msgId=i.msgId;f.send(JSON.stringify(m));i.addMessage("bubble-left","orange",0,"我","<b>"+l.join("<br>")+"</b>");};this.isdigit=function(k){var l,j;j=/\d*/i;l=k.match(j);return(l==k)?1:0;};this.addMessage=function(m,j,l,o,n){i.lastMessage=null;
if(n==undefined||n.length==0){return;}var k=[];k.push("<div class='bubbles "+m+" "+j+"'>");if(parseInt(l)<=100&&parseInt(l)>0){k.push("<a href='javascript:void(0)' class='avatar'><img src='/images/customerService.png'/></a>");}else{k.push("<a href='javascript:void(0)' class='avatar'>"+o.strip()+"</a>");
}k.push(n.replace(/\r/g,"<br>"));k.push("</div>");$("#messages").append(k.join(""));i.updateScrollbar();};this.callKFbyPhone=function(){if(a==false){alert("与服务器的网络连接已经断开，\n请关闭当前对话框，\n重新点击’联系@我‘");return;}if(checkLogin()==false){return;}if($("#bindMobile").val()!="1"){showFail("您的手机没有绑定，请<a class='redlink' target='_blank' href='/auth'>点击此处绑定</a>");
return;}var j=$("#mobile").val().trim();var k={};k.action="phone";k.content=j;f.send(JSON.stringify(k));i.addMessage("bubble-left","orange",0,"我","呼叫发送成功，客服人员将很快接通您的电话:"+j+",请稍候...通话过程中，您无需支付任何费用");};this.sendMessage=function(j){if(j==undefined||j.length==0){return;}var k={};k.action="say";k.content=j;
k.msgId=i.msgId;k.cookieId=$("#header").attr("cookieId");f.send(JSON.stringify(k));i.addMessage("bubble-left","orange",0,"我",j);};this.sendMsg=function(){i.lastMessage=$("#edtMsg").val().trim();if(i.lastMessage.length==0){showFail("请输入内容");$("#edtMsg").focus();return;}$("#edtMsg")[0].value="";$("#edtMsg").focus();
if(a==false){i.callNow(true);return;}i.sendMessage(i.lastMessage);};this.callNow=function(j){if(checkLogin()==false){return;}if(this.user.checkForm()==false){return;}i.initWebSocket(j);};};$.Follows=function(d,e){var b=0;var a=d;var c=this;this.afterRender=e;this.reload=function(f){var g={};b=f;g.pageNumber=f;
g.pageSize=a;g.funcIndex=25;showLoading("#spinner");$.ajax({type:"POST",url:"/user",dataType:"json",data:JSON.stringify(g),success:function(h){hideLoading("#spinner");if(h.xeach==false){return false;}c.renderFollows(h);}});};this.renderFollows=function(g){var f=new JsEvalContext(g);output=document.getElementById("follows");
template=jstGetTemplate("templateFollow");output.innerHTML="";output.appendChild(template);jstProcess(f,output);renderPage("#pager",g.followCount,b,a,this.readFollows);if(this.afterRender){this.afterRender.apply(this,[g]);}};};var user=new $.User();

